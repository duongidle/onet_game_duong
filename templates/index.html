<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
      body {
        margin: 0;
        font-family: "Segoe UI", sans-serif;
        background: linear-gradient(135deg, #0f172a, #1e293b);
        color: white;
      }
      #toast {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background: #22c55e;
        color: white;
        padding: 12px 20px;
        border-radius: 12px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
        font-weight: bold;
      }
      #toast.show {
        opacity: 1;
      }
      #lobby,
      #game {
        padding: 20px;
      }
      .board {
        display: grid;
        gap: 0;
        justify-content: center;
        margin-top: 20px;
      }
      .cell {
        width: 56px;
        height: 56px;
        background: linear-gradient(to bottom, #e6f3d6 0%, #c8dbb0 100%);
        border-radius: 2px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        overflow: hidden;
        box-shadow:
          inset 2px 2px 0 rgba(255, 255, 255, 0.6),
          inset -2px -2px 0 rgba(0, 0, 0, 0.25);
      }
      .cell {
        transition:
          box-shadow 0.2s ease,
          filter 0.2s ease;
      }
      .cell:hover {
        box-shadow:
          inset 0 2px 4px rgba(0, 0, 0, 0.25),
          inset 0 -2px 4px rgba(255, 255, 255, 0.35),
          0 0 8px rgba(255, 255, 255, 0.6);
      }
      .cell.selected {
        box-shadow:
          inset 0 2px 4px rgba(0, 0, 0, 0.25),
          inset 0 -2px 4px rgba(255, 255, 255, 0.35),
          0 0 12px #3b82f6;
        background: yellow;
      }
      .cell.fade-out {
        opacity: 0;
      }
      .cell img {
        width: 80%;
        height: 80%;
        object-fit: contain;
        image-rendering: pixelated;
        pointer-events: none;
      }
      #lineCanvas {
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: none;
      }
      .topbar {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        margin: 10px 60px;
      }

      .player {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .player.left {
        justify-content: flex-start;
      }

      .player.right {
        justify-content: flex-end;
      }

      .player-name {
        font-weight: bold;
        font-size: 18px;
      }

      .player-score {
        font-size: 22px;
        font-weight: bold;
        color: #facc15;
      }

      .vs-center {
        font-size: 28px;
        font-weight: bold;
        color: #ef4444;
      }
      .avatar {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: linear-gradient(
          45deg,
          red,
          orange,
          yellow,
          green,
          blue,
          indigo,
          violet
        );
        padding: 3px;
      }
      .avatar img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
      }
      .popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(145deg, #1e293b, #111827);
        padding: 40px 50px;
        border-radius: 24px;
        box-shadow: 0 30px 80px rgba(0, 0, 0, 0.6);
        text-align: center;
        min-width: 340px;
      }
      .popup-title {
        font-size: 26px;
        font-weight: bold;
        margin-bottom: 20px;
      }

      .popup-sub {
        font-size: 16px;
        opacity: 0.8;
        margin-bottom: 10px;
      }

      .room-code {
        font-size: 40px;
        font-weight: bold;
        letter-spacing: 3px;
        margin-bottom: 25px;
        color: #3b82f6;
      }

      .popup button {
        padding: 12px 26px;
        border-radius: 14px;
        border: none;
        font-weight: bold;
        cursor: pointer;
        font-size: 15px;
        transition: 0.2s;
        background: #3b82f6;
        color: white;
      }

      .popup button:hover {
        background: #2563eb;
        transform: translateY(-2px);
      }
      button {
        padding: 10px 15px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
      }
      #lobby {
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .lobby-card {
        background: #1e293b;
        padding: 40px;
        border-radius: 20px;
        width: 320px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
        text-align: center;
      }

      .lobby-title {
        font-size: 28px;
        margin-bottom: 25px;
        font-weight: bold;
      }

      .lobby-card input {
        width: 100%;
        padding: 12px;
        margin-bottom: 15px;
        border-radius: 10px;
        border: none;
        outline: none;
        background: #0f172a;
        color: white;
      }

      .lobby-card button {
        width: 100%;
        padding: 12px;
        margin-top: 10px;
        border-radius: 12px;
        border: none;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
        transition: 0.2s;
      }

      .btn-primary {
        background: #3b82f6;
        color: white;
      }

      .btn-primary:hover {
        background: #2563eb;
      }

      .btn-secondary {
        background: #334155;
        color: white;
      }

      .btn-secondary:hover {
        background: #475569;
      }
      .lobby-card input {
        width: 100%;
        padding: 14px;
        margin-bottom: 18px;
        border-radius: 12px;
        border: none;
        outline: none;
        background: #0f172a;
        color: white;
        font-size: 14px;
      }

      .lobby-actions {
        display: flex;
        justify-content: space-between;
        gap: 15px;
        margin-top: 10px;
      }

      .lobby-actions button {
        flex: 1;
        padding: 14px;
        border-radius: 14px;
        border: none;
        cursor: pointer;
        font-weight: bold;
        font-size: 15px;
        transition: 0.2s;
      }

      .btn-primary {
        background: #3b82f6;
        color: white;
      }

      .btn-primary:hover {
        background: #2563eb;
        transform: translateY(-2px);
      }

      .btn-secondary {
        background: #334155;
        color: white;
      }

      .btn-secondary:hover {
        background: #475569;
        transform: translateY(-2px);
      }
    </style>
  </head>
  <body>
    <div id="lobby">
      <form class="lobby-card" onsubmit="handleSubmit(event)">
        <div class="lobby-title">Onet Online</div>

        <input id="name" placeholder="Tên nhân vật" required />

        <input id="roomId" placeholder="Nhập mã phòng (nếu có)" />

        <div class="lobby-actions">
          <button type="button" class="btn-primary" onclick="createRoom()">
            Tạo phòng
          </button>
          <button type="submit" class="btn-secondary">Tham gia</button>
        </div>
      </form>
    </div>

    <div id="game" style="display: none">
      <div class="topbar" id="topbar"></div>
      <div class="board" id="board"></div>
    </div>

    <div id="popup" style="display: none" class="popup"></div>
    <canvas id="lineCanvas"></canvas>

    <script>
      const socket = io();
      let currentRoom = null;
      let selected = [];
      let boardState = [];

      let canvas = document.getElementById("lineCanvas");
      let ctx = canvas.getContext("2d");

      function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
      window.addEventListener("resize", resizeCanvas);
      resizeCanvas();

      function createRoom() {
        const nameInput = document.getElementById("name");

        if (!nameInput.checkValidity()) {
          nameInput.reportValidity();
          return;
        }

        const name = nameInput.value;
        socket.emit("create_room", { name });
      }

      function joinRoom() {
        const name = document.getElementById("name").value;
        const room = document.getElementById("roomId").value;

        currentRoom = room;

        socket.emit("join_room_request", {
          room: room,
          name: name,
        });
      }

      function copyRoom(id) {
        navigator.clipboard.writeText(id);
        showToast("Đã copy mã phòng");
      }

      socket.on("room_created", (data) => {
        currentRoom = data.room;

        document.getElementById("lobby").style.display = "none";
        document.getElementById("game").style.display = "block";

        document.getElementById("popup").innerHTML = `
        <div class="popup-title">Chờ người chơi</div>
        <div class="popup-sub">Mã phòng</div>
        <div class="room-code">${data.room}</div>
        <button onclick="copyRoom('${data.room}')">Copy mã phòng</button>
        `;

        document.getElementById("popup").style.display = "block";
      });

      socket.on("start_game", (data) => {
        currentRoom = data.room;
        boardState = data.board;

        // Tắt popup chờ phòng
        document.getElementById("popup").style.display = "none";

        document.getElementById("lobby").style.display = "none";
        document.getElementById("game").style.display = "block";

        renderTopbar(data.players, data.scores);
        renderBoard();
      });

      socket.on("update", (data) => {
        if (data.path) {
          drawPath(data.path);
        }

        if (data.removed) {
          fadeRemoved(data.removed);
        }

        setTimeout(() => {
          boardState = data.board;
          renderTopbar(null, data.scores);
          renderBoard();
        }, 250);
      });

      socket.on("game_over", (scores) => {
        let html = "<h3>Kết quả</h3>";
        for (let p in scores) {
          html += `<p>${scores[p]} điểm</p>`;
        }
        html += `<button onclick="exit()">Thoát</button>
           <button onclick="restart()">Chơi lại</button>`;
        document.getElementById("popup").innerHTML = html;
        document.getElementById("popup").style.display = "block";
      });

      socket.on("room_error", (data) => {
        showToast(data.msg);
      });

      socket.on("force_exit", (data) => {
        alert(data.msg);
        location.reload();
      });

      function renderTopbar(players, scores) {
        const top = document.getElementById("topbar");

        const ids = Object.keys(scores);

        if (players) {
          const p1 = ids[0];
          const p2 = ids[1];

          top.innerHTML = `
            <div class="player left">
                <div class="player-name">${players[p1]}</div>
                <div class="avatar"><img src="https://i.pravatar.cc/60?u=${p1}"></div>
                <div class="player-score" id="score_${p1}">${scores[p1]}</div>
            </div>

            <div class="vs-center">VS</div>

            <div class="player right">
                <div class="player-score" id="score_${p2}">${scores[p2]}</div>
                <div class="avatar"><img src="https://i.pravatar.cc/60?u=${p2}"></div>
                <div class="player-name">${players[p2]}</div>
            </div>
            `;
        } else {
          ids.forEach((id) => {
            document.getElementById("score_" + id).innerText = scores[id];
          });
        }
      }

      function renderBoard() {
        const board = document.getElementById("board");
        board.innerHTML = "";

        board.style.gridTemplateColumns = `repeat(${boardState[0].length}, 56px)`;

        for (let r = 0; r < boardState.length; r++) {
          for (let c = 0; c < boardState[r].length; c++) {
            const val = boardState[r][c];
            const cell = document.createElement("div");
            cell.className = "cell";
            cell.dataset.r = r;
            cell.dataset.c = c;

            if (val !== null) {
              const img = document.createElement("img");
              const imageIndex = val + 1;

              img.src = `/static/pika/pikafix/${imageIndex}.png`;
              img.loading = "lazy";

              cell.appendChild(img);
              cell.onclick = () => selectCell(r, c);
            }

            board.appendChild(cell);
          }
        }
      }

      function selectCell(r, c) {
        const cols = boardState[0].length;
        const index = r * cols + c;
        const all = document.querySelectorAll(".cell");
        const cell = all[index];

        // Nếu bấm lại chính nó → bỏ chọn
        if (
          selected.length === 1 &&
          selected[0][0] === r &&
          selected[0][1] === c
        ) {
          cell.classList.remove("selected");
          selected = [];
          return;
        }

        // Nếu đã chọn 1 ô trước đó → bỏ highlight ô cũ
        if (selected.length === 1) {
          const [pr, pc] = selected[0];
          const prevIndex = pr * cols + pc;
          all[prevIndex].classList.remove("selected");
        }

        selected.push([r, c]);
        cell.classList.add("selected");

        if (selected.length === 2) {
          socket.emit("select", {
            room: currentRoom,
            a: selected[0],
            b: selected[1],
          });

          // bỏ highlight sau khi gửi
          setTimeout(() => {
            all.forEach((c) => c.classList.remove("selected"));
          }, 200);

          selected = [];
        }
      }

      function fadeRemoved(cells) {
        const all = document.querySelectorAll(".cell");
        cells.forEach(([r, c]) => {
          const cols = boardState[0].length;
          const index = r * cols + c;
          if (all[index]) {
            all[index].classList.add("fade-out");
          }
        });
      }

      function drawPath(path) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = "yellow";
        ctx.lineWidth = 4;
        ctx.beginPath();

        const all = document.querySelectorAll(".cell");
        const rows = boardState.length;
        const cols = boardState[0].length;

        let started = false;

        path.forEach((point) => {
          const [r, c] = point;

          // Bỏ qua điểm padding ngoài board
          if (r < 0 || c < 0 || r >= rows || c >= cols) {
            return;
          }

          const index = r * cols + c;
          const cell = all[index];
          if (!cell) return;

          const rect = cell.getBoundingClientRect();
          const x = rect.left + rect.width / 2;
          const y = rect.top + rect.height / 2;

          if (!started) {
            ctx.moveTo(x, y);
            started = true;
          } else {
            ctx.lineTo(x, y);
          }
        });

        ctx.stroke();

        setTimeout(() => {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }, 250);
      }

      function restart() {
        socket.emit("restart", { room: currentRoom });
        document.getElementById("popup").style.display = "none";
      }

      function exit() {
        location.reload();
      }

      function showToast(message) {
        const toast = document.getElementById("toast");
        toast.innerText = message;
        toast.classList.add("show");

        setTimeout(() => {
          toast.classList.remove("show");
        }, 1000);
      }

      function handleSubmit(e) {
        e.preventDefault();

        const nameInput = document.getElementById("name");

        if (!nameInput.checkValidity()) {
          showToast("Vui lòng nhập tên nhân vật");
          return;
        }

        joinRoom();
      }
    </script>

    <div id="toast"></div>
  </body>
</html>
